name: 'Auto-release on CMake version merge'

# This workflow automatically creates a release when a PR with a new CMake version
# is merged to the main branch. It syncs the 'latest' branch and creates a version tag.

on:
  pull_request:
    types: [closed]
    branches:
      - main

concurrency:
  group: release-workflow
  cancel-in-progress: false

jobs:
  auto_release:
    name: 'Auto-create release for new CMake version'
    # Only run if PR was merged (not just closed) and title matches automated PR pattern
    if: |
      github.event.pull_request.merged == true &&
      contains(github.event.pull_request.title, '[Automated] Adding')
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: main

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Determine version and check if release needed
        id: check_version
        run: |
          # Read the current CMake version from main
          CMAKE_VERSION=$(cat .latest_cmake_version)
          echo "CMAKE_VERSION=$CMAKE_VERSION" >> $GITHUB_OUTPUT
          echo "Current CMake version: $CMAKE_VERSION"
          
          # Check if tag already exists
          if git ls-remote --tags origin | grep -q "refs/tags/v${CMAKE_VERSION}$"; then
            echo "Tag v${CMAKE_VERSION} already exists, skipping release"
            echo "SHOULD_RELEASE=false" >> $GITHUB_OUTPUT
          else
            echo "Tag v${CMAKE_VERSION} does not exist, will create release"
            echo "SHOULD_RELEASE=true" >> $GITHUB_OUTPUT
          fi

      - name: Update latest branch to match main
        run: |
          # Always update latest branch to match main, even if tag exists
          # This ensures latest branch is always in sync
          MAIN_SHA=$(git rev-parse HEAD)
          echo "Main branch is at commit: $MAIN_SHA"

          # Force update the latest branch to match main
          git push origin HEAD:refs/heads/latest --force
          echo "âœ“ Latest branch updated to match main"

      - name: Create and push version tag
        if: steps.check_version.outputs.SHOULD_RELEASE == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG_NAME="v${{ steps.check_version.outputs.CMAKE_VERSION }}"
          COMMIT_SHA=$(git rev-parse HEAD)
          
          # Create tag object using GitHub API (this creates a verified tag)
          TAG_RESPONSE=$(gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/git/tags \
            -f tag="$TAG_NAME" \
            -f message="Release $TAG_NAME - CMake ${{ steps.check_version.outputs.CMAKE_VERSION }}" \
            -f object="$COMMIT_SHA" \
            -f type="commit")
          
          TAG_SHA=$(echo "$TAG_RESPONSE" | jq -r '.sha')
          echo "Created tag object with SHA: $TAG_SHA"
          
          # Create reference to the tag
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/git/refs \
            -f ref="refs/tags/$TAG_NAME" \
            -f sha="$TAG_SHA"
          
          echo "âœ“ Verified tag $TAG_NAME created and pushed"

      - name: Create release summary
        run: |
          if [[ "${{ steps.check_version.outputs.SHOULD_RELEASE }}" == "true" ]]; then
            echo "## ðŸŽ‰ Release v${{ steps.check_version.outputs.CMAKE_VERSION }} created!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Changes" >> $GITHUB_STEP_SUMMARY
            echo "- CMake version updated to ${{ steps.check_version.outputs.CMAKE_VERSION }}" >> $GITHUB_STEP_SUMMARY
            echo "- Latest branch synced with main" >> $GITHUB_STEP_SUMMARY
            echo "- Tag \`v${{ steps.check_version.outputs.CMAKE_VERSION }}\` created" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Usage" >> $GITHUB_STEP_SUMMARY
            echo "Users can now reference this release using:" >> $GITHUB_STEP_SUMMARY
            echo '```yaml' >> $GITHUB_STEP_SUMMARY
            echo "- uses: lukka/get-cmake@latest" >> $GITHUB_STEP_SUMMARY
            echo "- uses: lukka/get-cmake@v${{ steps.check_version.outputs.CMAKE_VERSION }}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "## â„¹ï¸ Latest branch synced, tag already exists" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Latest branch updated to match main" >> $GITHUB_STEP_SUMMARY
            echo "- Tag v${{ steps.check_version.outputs.CMAKE_VERSION }} already exists (not recreated)" >> $GITHUB_STEP_SUMMARY
          fi
